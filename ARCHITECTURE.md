# Bellwood Admin Portal - System Architecture

## ??? System Overview

```
???????????????????????????????????????????????????????????????????????
?                        BELLWOOD ECOSYSTEM                            ?
???????????????????????????????????????????????????????????????????????
?                                                                      ?
?  ??????????????????     ??????????????????     ?????????????????? ?
?  ?  AuthServer    ?     ?   AdminAPI     ?     ?  AdminPortal   ? ?
?  ?                ?     ?                ?     ?                ? ?
?  ?  :5001         ?     ?  :5206         ?     ?  :7257         ? ?
?  ?                ?     ?                ?     ?                ? ?
?  ?  - User DB     ?     ?  - Bookings    ?     ?  - Blazor UI   ? ?
?  ?  - JWT Tokens  ?     ?  - Quotes      ?     ?  - Staff Login ? ?
?  ?  - Identity    ?     ?  - File Store  ?     ?  - Dashboard   ? ?
?  ??????????????????     ??????????????????     ?????????????????? ?
?           ?                      ?                       ?         ?
?           ?         ?????????????????????????????????????         ?
?           ?         ?                        ?                     ?
?           ?    API Key:                 JWT Token:                 ?
?           ?    dev-secret-123          (from AuthServer)           ?
?           ?                                                         ?
?           ???????????????? Login Flow ??????????????????????????????
?                                                                      ?
???????????????????????????????????????????????????????????????????????
```

## ?? Authentication Flow (Detailed)

```
????????????
? Browser  ?
????????????
     ?
     ? 1. GET https://localhost:7257
     ?
???????????????????????????????????????????????????????????????????
? AdminPortal (Blazor Server)                                     ?
?                                                                 ?
?  ??????????????????????????????????????????????????????????   ?
?  ? App.razor                                              ?   ?
?  ?   <CascadingAuthenticationState>                       ?   ?
?  ?     <Router>                                           ?   ?
?  ?       <AuthorizeRouteView>                             ?   ?
?  ?         Checks: AuthenticationStateProvider            ?   ?
?  ??????????????????????????????????????????????????????????   ?
?                       ?                                         ?
?                       ? Not Authenticated                       ?
?                       ?                                         ?
?  ??????????????????????????????????????????????????????????   ?
?  ? Home.razor (/)                                         ?   ?
?  ?   <AuthorizeView>                                      ?   ?
?  ?     <NotAuthorized>                                    ?   ?
?  ?       Navigation.NavigateTo("/login")                  ?   ?
?  ??????????????????????????????????????????????????????????   ?
?                       ?                                         ?
?                       ? 2. Redirect to /login                   ?
?                       ?                                         ?
?  ??????????????????????????????????????????????????????????   ?
?  ? Login.razor                                            ?   ?
?  ?   @rendermode InteractiveServer                        ?   ?
?  ?   @layout EmptyLayout                                  ?   ?
?  ?                                                        ?   ?
?  ?   <EditForm>                                           ?   ?
?  ?     Username: [alice    ]                              ?   ?
?  ?     Password: [••••••••]                               ?   ?
?  ?     [Login Button]                                     ?   ?
?  ?   </EditForm>                                          ?   ?
?  ??????????????????????????????????????????????????????????   ?
?                       ?                                         ?
???????????????????????????????????????????????????????????????????
                        ?
                        ? 3. POST /api/auth/login
                        ?    { username, password }
                        ?
???????????????????????????????????????????????????????????????????
? AuthServer (ASP.NET Core Identity)                              ?
?                                                                 ?
?  ??????????????????????????????????????????????????????????   ?
?  ? /api/auth/login endpoint                               ?   ?
?  ?                                                        ?   ?
?  ?  1. Validate credentials against user database         ?   ?
?  ?  2. If valid, generate JWT token                       ?   ?
?  ?  3. Return: { accessToken, refreshToken }              ?   ?
?  ??????????????????????????????????????????????????????????   ?
?                       ?                                         ?
???????????????????????????????????????????????????????????????????
                        ?
                        ? 4. Response:
                        ?    { accessToken: "eyJ...", ... }
                        ?
???????????????????????????????????????????????????????????????????
? AdminPortal - Login.razor                                       ?
?                                                                 ?
?  var result = await response.Content                            ?
?    .ReadFromJsonAsync<LoginResponse>();                         ?
?                                                                 ?
?  if (result?.AccessToken != null) {                             ?
?                                                                 ?
?    // KEY STEP: Update Blazor's auth state                      ?
?    await AuthStateProvider                                      ?
?      .MarkUserAsAuthenticatedAsync(username, token);            ?
?                                                                 ?
?    // This does:                                                ?
?    // 1. Store token ? AuthTokenProvider                        ?
?    // 2. Create Claims (Name, Role, Token)                      ?
?    // 3. Notify Blazor: NotifyAuthenticationStateChanged()      ?
?                                                                 ?
?    Navigation.NavigateTo("/bookings");                          ?
?  }                                                              ?
?                                                                 ?
???????????????????????????????????????????????????????????????????
                        ?
                        ? 5. Navigate to /bookings
                        ?
???????????????????????????????????????????????????????????????????
? Bookings.razor                                                  ?
?                                                                 ?
?  <AuthorizeView>                                                ?
?    <Authorized> ? (State was updated in step 4!)               ?
?                                                                 ?
?      protected override async Task OnInitializedAsync() {       ?
?        await LoadBookingsAsync();                               ?
?      }                                                          ?
?                                                                 ?
???????????????????????????????????????????????????????????????????
                        ?
                        ? 6. GET /bookings/list?take=100
                        ?    Headers:
                        ?      X-Admin-ApiKey: dev-secret-123
                        ?      Authorization: Bearer eyJ...
                        ?
???????????????????????????????????????????????????????????????????
? AdminAPI                                                        ?
?                                                                 ?
?  app.MapGet("/bookings/list", async (req, repo) => {            ?
?                                                                 ?
?    // Validate API key                                          ?
?    if (req.Headers["X-Admin-ApiKey"] != configuredKey)          ?
?      return Results.Unauthorized();                             ?
?                                                                 ?
?    // Fetch bookings                                            ?
?    var bookings = await repo.ListAsync(take);                   ?
?    return Results.Ok(bookings);                                 ?
?  });                                                            ?
?                                                                 ?
???????????????????????????????????????????????????????????????????
                        ?
                        ? 7. Response:
                        ?    [{ booking1 }, { booking2 }, ...]
                        ?
???????????????????????????????????????????????????????????????????
? Bookings.razor                                                  ?
?                                                                 ?
?  allBookings = await response.Content                           ?
?    .ReadFromJsonAsync<List<BookingListItem>>();                 ?
?                                                                 ?
?  FilterBookings("All");                                         ?
?                                                                 ?
?  ??????????????????????????????????????????????????????????   ?
?  ? ?? Bookings Dashboard                                  ?   ?
?  ?                                                        ?   ?
?  ? [All (3)] [Requested] [Confirmed] [Completed]          ?   ?
?  ?                                                        ?   ?
?  ? ????????????????????????????????????????????????????  ?   ?
?  ? ? Taylor Reed                     [Requested]       ?  ?   ?
?  ? ? SUV • 12/10/2024 3:00 PM                          ?  ?   ?
?  ? ? ?? O'Hare FBO                                     ?  ?   ?
?  ? ????????????????????????????????????????????????????  ?   ?
?  ? ...                                                    ?   ?
?  ??????????????????????????????????????????????????????????   ?
?                                                                 ?
???????????????????????????????????????????????????????????????????
```

## ?? Component Architecture

```
AdminPortal Project Structure
??? Components/
?   ??? App.razor ?????????????????? Root component
?   ?   ??? <CascadingAuthenticationState>
?   ?       ??? <Router>
?   ?           ??? <Found> ? AuthorizeRouteView
?   ?           ??? <NotFound> ? 404 page
?   ?
?   ??? Layout/
?   ?   ??? MainLayout.razor ??????? Authenticated pages
?   ?   ?   ??? <NavMenu />
?   ?   ?   ??? @Body (page content)
?   ?   ?
?   ?   ??? EmptyLayout.razor ?????? Login/public pages
?   ?       ??? @Body (minimal)
?   ?
?   ??? Pages/
?       ??? Home.razor (@page "/")
?       ?   ??? Redirects based on auth state
?       ?
?       ??? Login.razor (@page "/login")
?       ?   ??? EditForm for credentials
?       ?   ??? Calls AuthServer
?       ?   ??? Updates auth state
?       ?
?       ??? Bookings.razor (@page "/bookings")
?       ?   ??? <AuthorizeView>
?       ?   ??? Loads data from AdminAPI
?       ?   ??? Displays dashboard
?       ?
?       ??? Logout.razor (@page "/logout")
?           ??? Clears auth state
?
??? Services/
?   ??? IAuthTokenProvider.cs
?   ??? AuthTokenProvider.cs ??????????? Stores JWT token in memory
?   ?
?   ??? IAdminApiKeyProvider.cs
?   ??? AdminApiKeyProvider.cs ????????? Reads API key from config
?   ?
?   ??? JwtAuthenticationStateProvider.cs ???? Bridges auth to Blazor
?       ??? GetAuthenticationStateAsync()
?       ??? MarkUserAsAuthenticatedAsync()
?       ??? MarkUserAsLoggedOutAsync()
?
??? Program.cs ?????????????????????????? DI & middleware setup
?   ??? AddRazorComponents()
?   ??? AddAuthorizationCore()
?   ??? AddCascadingAuthenticationState()
?   ??? AddHttpClient("AuthServer")
?   ??? AddHttpClient("AdminAPI")
?   ??? MapRazorComponents<App>()
?
??? appsettings.Development.json ???????? Configuration
    ??? Logging
    ??? AdminApi
        ??? BaseUrl: https://localhost:5206
        ??? ApiKey: dev-secret-123
```

## ?? State Management

```
??????????????????????????????????????????????????????????????
? Authentication State Flow                                   ?
??????????????????????????????????????????????????????????????

Login Success
    ?
    ??? AuthTokenProvider.SetTokenAsync(token)
    ?   ??? Stores token in memory (_cachedToken)
    ?
    ??? JwtAuthenticationStateProvider
            .MarkUserAsAuthenticatedAsync(username, token)
        ?
        ??? Creates ClaimsPrincipal with:
        ?   - ClaimTypes.Name = username
        ?   - ClaimTypes.Role = "Staff"
        ?   - "access_token" = token
        ?
        ??? NotifyAuthenticationStateChanged()
            ?
            ??? Triggers re-evaluation in:
                ??? <AuthorizeView> components
                ??? <AuthorizeRouteView> routing
                ??? @context in authorized sections

On Logout
    ?
    ??? AuthTokenProvider.ClearTokenAsync()
    ?   ??? Sets _cachedToken = null
    ?
    ??? JwtAuthenticationStateProvider
            .MarkUserAsLoggedOutAsync()
        ?
        ??? Creates empty ClaimsPrincipal
            ??? NotifyAuthenticationStateChanged()
                ??? User sees <NotAuthorized> content
```

## ?? HTTP Client Configuration

```
??????????????????????????????????????????????????????????????
? HttpClientFactory Configuration                            ?
??????????????????????????????????????????????????????????????

Program.cs registers two named clients:

1. "AuthServer"
   ??? BaseAddress: https://localhost:5001
   ??? Timeout: 30 seconds
   ??? Used by: Login.razor
       ??? POST /api/auth/login

2. "AdminAPI"
   ??? BaseAddress: https://localhost:5206
   ??? Timeout: 30 seconds
   ??? Used by: Bookings.razor
       ??? GET /bookings/list?take=100
       
Usage in components:
   var client = HttpFactory.CreateClient("AdminAPI");
   
   // Add headers
   client.DefaultRequestHeaders.TryAddWithoutValidation(
       "X-Admin-ApiKey", apiKey);
   
   client.DefaultRequestHeaders.Authorization = 
       new AuthenticationHeaderValue("Bearer", token);
   
   // Make request
   var bookings = await client.GetFromJsonAsync<List<...>>(...);
```

## ?? Future: OAuth 2.0 Integration

```
Current Flow:
   Login.razor ? AuthServer ? JWT Token ? Store & Use

OAuth 2.0 Flow (Future):
   Login.razor ? OAuth Provider (LimoAnywhere)
       ?
   Authorization Code
       ?
   Exchange Code ? Access Token + Refresh Token
       ?
   Store Tokens
       ?
   Use Access Token for API calls
       ?
   Refresh Token when expired

Changes Needed:
   1. Replace direct login with OAuth redirect
   2. Add OAuth callback handler (/oauth/callback)
   3. Implement token refresh logic
   4. Update token storage (add refresh token)
   
No architectural changes needed! 
The AuthTokenProvider pattern already supports this.
```

---

## ?? Key Takeaways

### 1. **Separation of Concerns**
- **AuthServer** = User authentication & token generation
- **AdminAPI** = Business data (bookings, quotes)
- **AdminPortal** = User interface & experience

### 2. **Authentication vs Authorization**
- **Authentication** = Who are you? (Login with credentials)
- **Authorization** = What can you do? (Staff role, view bookings)

### 3. **Blazor Auth Pattern**
- Store token ? `AuthTokenProvider`
- Manage auth state ? `JwtAuthenticationStateProvider`
- Protect UI ? `<AuthorizeView>`
- Protect routes ? `<AuthorizeRouteView>`

### 4. **HTTP Communication**
- Named clients for different services
- Headers for security (API key, Bearer token)
- Proper error handling and user feedback

---

This architecture is:
- ? Testable (each service independent)
- ? Scalable (can add more services)
- ? Maintainable (clear separation)
- ? OAuth-ready (token provider pattern)
