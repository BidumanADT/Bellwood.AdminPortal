@page "/bookings/{BookingId}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Bellwood.AdminPortal.Models
@using Bellwood.AdminPortal.Services
@using System.Net.Http.Headers
@using System.Net.Http.Json
@inject IHttpClientFactory HttpFactory
@inject IAuthTokenProvider TokenProvider
@inject IAdminApiKeyProvider ApiKeyProvider
@inject IAffiliateService AffiliateService
@inject IDriverTrackingService TrackingService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Booking Detail - Bellwood Elite</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col">
                    <button class="btn btn-outline-secondary mb-3" @onclick="GoBack">
                        ? Back to Bookings
                    </button>
                    <h2 class="text-bellwood-gold">?? Booking Details</h2>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-bellwood-gold" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (booking == null)
            {
                <div class="alert alert-danger">
                    Booking not found.
                </div>
            }
            else
            {
                <div class="row">
                    <!-- Booking Information Card -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-3">Booking Information</h4>
                                
                                <div class="mb-3">
                                    <strong>Booking ID:</strong> @booking.Id
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Status:</strong>
                                    <span class="status-chip status-@(booking.DisplayStatus.ToLower())">
                                        @booking.DisplayStatus
                                    </span>
                                    @if (!string.IsNullOrEmpty(booking.CurrentRideStatus) && booking.CurrentRideStatus != booking.Status)
                                    {
                                        <br />
                                        <small class="text-muted">Booking Status: @booking.Status</small>
                                    }
                                </div>

                                <div class="mb-3">
                                    <strong>Passenger:</strong> @booking.PassengerName
                                </div>

                                <div class="mb-3">
                                    <strong>Booker:</strong> @booking.BookerName
                                </div>

                                <div class="mb-3">
                                    <strong>Vehicle Class:</strong> @booking.VehicleClass
                                </div>

                                <div class="mb-3">
                                    <strong>Pickup:</strong> @booking.PickupLocation
                                </div>

                                @if (!string.IsNullOrEmpty(booking.DropoffLocation))
                                {
                                    <div class="mb-3">
                                        <strong>Dropoff:</strong> @booking.DropoffLocation
                                    </div>
                                }

                                <div class="mb-3">
                                    <strong>Pickup Time:</strong> @booking.PickupDateTime.ToLocalTime().ToString("g")
                                </div>

                                <div class="mb-3">
                                    <strong>Created:</strong> @booking.CreatedUtc.ToLocalTime().ToString("g")
                                </div>
                            </div>
                        </div>

                        <!-- Live Tracking Card (shown for active rides) -->
                        @if (IsTrackable(booking))
                        {
                            <div class="card mt-3">
                                <div class="card-body">
                                    <h4 class="card-title mb-3">??? Live Tracking</h4>
                                    
                                    @if (driverLocation != null)
                                    {
                                        <div class="mb-3 p-3" style="background: rgba(40, 167, 69, 0.1); border-radius: 8px; border-left: 3px solid #28a745;">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong class="text-success">?? Driver Location Active</strong>
                                                    <br />
                                                    <small class="text-muted">
                                                        Last update: @driverLocation.Timestamp.ToLocalTime().ToString("g")
                                                        (@GetTimeAgo(driverLocation.Timestamp))
                                                    </small>
                                                </div>
                                                @if (driverLocation.Speed.HasValue)
                                                {
                                                    <div class="text-end">
                                                        <span class="badge bg-info">
                                                            @($"{driverLocation.Speed.Value * 2.237:F0} mph")
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    Coordinates: @driverLocation.Latitude.ToString("F6"), @driverLocation.Longitude.ToString("F6")
                                                </small>
                                            </div>
                                        </div>
                                    }
                                    else if (isLoadingLocation)
                                    {
                                        <div class="text-center py-2">
                                            <div class="spinner-border spinner-border-sm text-bellwood-gold"></div>
                                            <span class="ms-2">Checking driver location...</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mb-3 p-3" style="background: rgba(108, 117, 125, 0.1); border-radius: 8px;">
                                            <span class="text-muted">?? No location data available yet.</span>
                                            <br />
                                            <small class="text-muted">
                                                Location will appear once the driver starts sharing their position.
                                            </small>
                                        </div>
                                    }

                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary" @onclick="ViewOnMap">
                                            ??? View on Live Map
                                        </button>
                                        <button class="btn btn-outline-secondary" @onclick="RefreshLocation">
                                            ?? Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Driver Assignment Card -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-3">Driver Assignment</h4>
                                
                                <!-- Current Assignment -->
                                <div class="mb-4 p-3" style="background: rgba(203, 161, 53, 0.1); border-radius: 8px;">
                                    <strong>Current Driver:</strong>
                                    @if (string.IsNullOrEmpty(booking.AssignedDriverName))
                                    {
                                        <span class="text-warning ms-2">Unassigned</span>
                                    }
                                    else
                                    {
                                        <span class="text-success ms-2">? @booking.AssignedDriverName</span>
                                        @if (!string.IsNullOrEmpty(booking.AssignedDriverUid))
                                        {
                                            <br/>
                                            <small class="text-muted">UID: @booking.AssignedDriverUid</small>
                                        }
                                        else if (!string.IsNullOrEmpty(booking.AssignedDriverId))
                                        {
                                            <br/>
                                            <small class="text-warning">?? Driver not linked to AuthServer - won't see this ride in driver app</small>
                                        }
                                    }
                                </div>

                                @if (!string.IsNullOrEmpty(successMessage))
                                {
                                    <div class="alert alert-success">
                                        @successMessage
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(errorMessage))
                                {
                                    <div class="alert alert-danger">
                                        @errorMessage
                                    </div>
                                }

                                <!-- Driver Selection -->
                                @if (isLoadingAffiliates)
                                {
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-bellwood-gold"></div>
                                        <span class="ms-2">Loading affiliates...</span>
                                    </div>
                                }
                                else if (!affiliates.Any())
                                {
                                    <div class="alert alert-info">
                                        No affiliates found. Create affiliates and drivers in the Affiliates page first.
                                    </div>
                                }
                                else
                                {
                                    <h5 class="mb-3">Select Driver:</h5>
                                    
                                    @foreach (var affiliate in affiliates)
                                    {
                                        <div class="card mb-3" style="background: rgba(45, 45, 45, 0.6);">
                                            <div class="card-header" style="cursor: pointer;" @onclick="() => ToggleAffiliate(affiliate.Id)">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong>@affiliate.Name</strong>
                                                    <span>
                                                        @if (expandedAffiliates.Contains(affiliate.Id))
                                                        {
                                                            <span>?</span>
                                                        }
                                                        else
                                                        {
                                                            <span>?</span>
                                                        }
                                                    </span>
                                                </div>
                                                <small class="text-muted">@affiliate.Drivers.Count driver(s)</small>
                                            </div>
                                            
                                            @if (expandedAffiliates.Contains(affiliate.Id))
                                            {
                                                <div class="card-body">
                                                    @if (!affiliate.Drivers.Any())
                                                    {
                                                        <p class="text-muted">No drivers for this affiliate.</p>
                                                    }
                                                    else
                                                    {
                                                        <div class="list-group list-group-flush">
                                                            @foreach (var driver in affiliate.Drivers)
                                                            {
                                                                <div class="list-group-item" style="background: transparent; border-color: rgba(203, 161, 53, 0.2);">
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <div>
                                                                            <strong>@driver.Name</strong>
                                                                            @if (string.IsNullOrEmpty(driver.UserUid))
                                                                            {
                                                                                <span class="badge bg-warning text-dark ms-2" title="Driver won't see assigned rides">
                                                                                    Not linked
                                                                                </span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="badge bg-success ms-2" title="Driver is linked to AuthServer">
                                                                                    Linked
                                                                                </span>
                                                                            }
                                                                            <br/>
                                                                            <small class="text-muted">@driver.Phone</small>
                                                                            @if (!string.IsNullOrEmpty(driver.UserUid))
                                                                            {
                                                                                <small class="text-muted"> • UID: @driver.UserUid</small>
                                                                            }
                                                                        </div>
                                                                        <button class="btn btn-sm btn-primary" 
                                                                                @onclick="() => AssignDriver(driver)"
                                                                                disabled="@isAssigning">
                                                                            @if (isAssigning && selectedDriverId == driver.Id)
                                                                            {
                                                                                <span class="spinner-border spinner-border-sm"></span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span>Assign</span>
                                                                            }
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                    
                                                    <!-- Add Driver Form -->
                                                    @if (showAddDriverForm && addDriverAffiliateId == affiliate.Id)
                                                    {
                                                        <div class="mt-3 p-3" style="background: rgba(203, 161, 53, 0.1); border-radius: 8px;">
                                                            <h6>Add New Driver</h6>
                                                            <div class="mb-2">
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       placeholder="Driver Name *" 
                                                                       @bind="newDriverName" />
                                                            </div>
                                                            <div class="mb-2">
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       placeholder="Driver Phone *" 
                                                                       @bind="newDriverPhone" />
                                                            </div>
                                                            <div class="mb-2">
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       placeholder="User UID (e.g., driver-001)" 
                                                                       @bind="newDriverUserUid" />
                                                                <small class="form-text text-muted">
                                                                    Enter the driver's AuthServer UID to enable ride visibility in driver app.
                                                                </small>
                                                            </div>
                                                            <div class="d-flex gap-2">
                                                                <button class="btn btn-sm btn-success" 
                                                                        @onclick="() => SaveNewDriver(affiliate.Id)"
                                                                        disabled="@isAddingDriver">
                                                                    @if (isAddingDriver)
                                                                    {
                                                                        <span class="spinner-border spinner-border-sm"></span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span>Save</span>
                                                                    }
                                                                </button>
                                                                <button class="btn btn-sm btn-secondary" 
                                                                        @onclick="CancelAddDriver">
                                                                    Cancel
                                                                </button>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-sm btn-outline-primary mt-3" 
                                                                @onclick="() => ShowAddDriverForm(affiliate.Id)">
                                                            + Add Driver
                                                        </button>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        @{
            Navigation.NavigateTo("/login");
        }
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string BookingId { get; set; } = string.Empty;

    private BookingInfo? booking;
    private List<AffiliateDto> affiliates = new();
    private HashSet<string> expandedAffiliates = new();
    private LocationResponse? driverLocation;
    
    private bool isLoading = true;
    private bool isLoadingAffiliates = false;
    private bool isLoadingLocation = false;
    private bool isAssigning = false;
    private bool isAddingDriver = false;
    private bool showAddDriverForm = false;
    
    private string? selectedDriverId;
    private string? addDriverAffiliateId;
    private string newDriverName = string.Empty;
    private string newDriverPhone = string.Empty;
    private string? newDriverUserUid;
    
    private string? successMessage;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to real-time status updates
        TrackingService.RideStatusChanged += OnRideStatusChanged;
        
        // Connect to SignalR if not already connected
        if (!TrackingService.IsConnected)
        {
            await TrackingService.ConnectAsync();
        }
        
        await LoadBookingAsync();
        await LoadAffiliatesAsync();
        
        // Load driver location for trackable rides
        if (booking != null && IsTrackable(booking))
        {
            await LoadDriverLocationAsync();
        }
    }

    private async Task LoadBookingAsync()
    {
        isLoading = true;
        try
        {
            var client = HttpFactory.CreateClient("AdminAPI");
            
            var apiKey = ApiKeyProvider.GetApiKey();
            if (!string.IsNullOrWhiteSpace(apiKey))
            {
                client.DefaultRequestHeaders.TryAddWithoutValidation("X-Admin-ApiKey", apiKey);
            }

            var token = await TokenProvider.GetTokenAsync();
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            }

            var response = await client.GetAsync($"/bookings/{BookingId}");
            
            // Phase 1: Handle 403 Forbidden responses from AdminAPI
            if (response.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                errorMessage = "Access denied. You don't have permission to view this booking.";
                Console.WriteLine($"[BookingDetail] 403 Forbidden for booking {BookingId}");
                booking = null;
                return;
            }
            
            response.EnsureSuccessStatusCode();
            booking = await response.Content.ReadFromJsonAsync<BookingInfo>();
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
        {
            errorMessage = "Access denied. You don't have permission to view this booking.";
            Console.WriteLine($"[BookingDetail] 403 Forbidden: {errorMessage}");
            booking = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load booking: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadAffiliatesAsync()
    {
        isLoadingAffiliates = true;
        try
        {
            affiliates = await AffiliateService.GetAffiliatesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load affiliates: {ex.Message}";
        }
        finally
        {
            isLoadingAffiliates = false;
        }
    }

    private async Task LoadDriverLocationAsync()
    {
        isLoadingLocation = true;
        try
        {
            driverLocation = await TrackingService.GetRideLocationAsync(BookingId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load driver location: {ex.Message}");
        }
        finally
        {
            isLoadingLocation = false;
        }
    }

    private async Task RefreshLocation()
    {
        await LoadDriverLocationAsync();
    }

    private void ViewOnMap()
    {
        Navigation.NavigateTo("/tracking");
    }

    private bool IsTrackableStatus(string? status)
    {
        if (string.IsNullOrEmpty(status)) return false;
        // Only OnRoute, Arrived, and PassengerOnboard are truly trackable
        // Removed 'Confirmed' as that's before driver starts
        var trackableStatuses = new[] { "OnRoute", "Arrived", "PassengerOnboard" };
        return trackableStatuses.Contains(status, StringComparer.OrdinalIgnoreCase);
    }
    
    /// <summary>
    /// Determines if the booking is in a trackable state.
    /// Checks CurrentRideStatus first, then falls back to Status for InProgress.
    /// </summary>
    private bool IsTrackable(BookingInfo? booking)
    {
        if (booking == null) return false;
        
        // Check CurrentRideStatus first (real-time driver state)
        if (!string.IsNullOrEmpty(booking.CurrentRideStatus))
        {
            return IsTrackableStatus(booking.CurrentRideStatus);
        }
        
        // Fallback to BookingStatus for older bookings
        return booking.Status?.Equals("InProgress", StringComparison.OrdinalIgnoreCase) == true;
    }

    private string GetTimeAgo(DateTime timestamp)
    {
        var age = DateTime.UtcNow - timestamp;
        if (age.TotalSeconds < 60) return "just now";
        if (age.TotalMinutes < 60) return $"{(int)age.TotalMinutes}m ago";
        return $"{(int)age.TotalHours}h ago";
    }

    private void ToggleAffiliate(string affiliateId)
    {
        if (expandedAffiliates.Contains(affiliateId))
        {
            expandedAffiliates.Remove(affiliateId);
        }
        else
        {
            expandedAffiliates.Add(affiliateId);
        }
    }

    private async Task AssignDriver(DriverDto driver)
    {
        isAssigning = true;
        selectedDriverId = driver.Id;
        successMessage = null;
        errorMessage = null;

        try
        {
            await AffiliateService.AssignDriverToBookingAsync(BookingId, driver.Id);
            
            // Update local booking state
            if (booking != null)
            {
                booking.AssignedDriverId = driver.Id;
                booking.AssignedDriverName = driver.Name;
                booking.AssignedDriverUid = driver.UserUid;
            }
            
            var warningMessage = string.IsNullOrEmpty(driver.UserUid) 
                ? " ?? Note: Driver is not linked to AuthServer and won't see this ride in the driver app."
                : "";
            successMessage = $"? Driver assigned successfully! {driver.Name} will handle this booking. Affiliate has been notified via email.{warningMessage}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to assign driver: {ex.Message}";
        }
        finally
        {
            isAssigning = false;
            selectedDriverId = null;
        }
    }

    private void ShowAddDriverForm(string affiliateId)
    {
        showAddDriverForm = true;
        addDriverAffiliateId = affiliateId;
        newDriverName = string.Empty;
        newDriverPhone = string.Empty;
        newDriverUserUid = null;
    }

    private void CancelAddDriver()
    {
        showAddDriverForm = false;
        addDriverAffiliateId = null;
        newDriverName = string.Empty;
        newDriverPhone = string.Empty;
        newDriverUserUid = null;
    }

    private async Task SaveNewDriver(string affiliateId)
    {
        if (string.IsNullOrWhiteSpace(newDriverName) || string.IsNullOrWhiteSpace(newDriverPhone))
        {
            errorMessage = "Please enter both driver name and phone.";
            return;
        }

        isAddingDriver = true;
        errorMessage = null;

        try
        {
            var newDriver = new DriverDto
            {
                AffiliateId = affiliateId,
                Name = newDriverName,
                Phone = newDriverPhone,
                UserUid = string.IsNullOrWhiteSpace(newDriverUserUid) ? null : newDriverUserUid.Trim()
            };

            var driverId = await AffiliateService.AddDriverToAffiliateAsync(affiliateId, newDriver);
            newDriver.Id = driverId;

            // Add to local state
            var affiliate = affiliates.FirstOrDefault(a => a.Id == affiliateId);
            if (affiliate != null)
            {
                affiliate.Drivers.Add(newDriver);
            }

            CancelAddDriver();
            var linkedMessage = string.IsNullOrEmpty(newDriver.UserUid) 
                ? " (Note: Driver is not linked to AuthServer)"
                : $" (Linked to UID: {newDriver.UserUid})";
            successMessage = $"Driver added successfully!{linkedMessage}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to add driver: {ex.Message}";
        }
        finally
        {
            isAddingDriver = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/bookings");
    }

    public class BookingInfo
    {
        public string Id { get; set; } = string.Empty;
        public DateTime CreatedUtc { get; set; }
        public string? Status { get; set; }
        /// <summary>
        /// Real-time driver status (OnRoute, Arrived, PassengerOnboard, etc.)
        /// Takes precedence over Status for displaying current ride state.
        /// </summary>
        public string? CurrentRideStatus { get; set; }
        public string BookerName { get; set; } = string.Empty;
        public string PassengerName { get; set; } = string.Empty;
        public string VehicleClass { get; set; } = string.Empty;
        public string PickupLocation { get; set; } = string.Empty;
        public string? DropoffLocation { get; set; }
        public DateTime PickupDateTime { get; set; }
        public DateTimeOffset? PickupDateTimeOffset { get; set; }  // New timezone-aware field
        public string? AssignedDriverId { get; set; }
        public string? AssignedDriverName { get; set; }
        /// <summary>
        /// The assigned driver's AuthServer UID. Used for admin debugging 
        /// to verify the driver can see this booking in the driver app.
        /// </summary>
        public string? AssignedDriverUid { get; set; }
        
        // Phase 1: Audit trail fields (added January 2026)
        /// <summary>
        /// User ID (GUID) of the user who created this booking.
        /// Null for legacy bookings created before Phase 1.
        /// </summary>
        public string? CreatedByUserId { get; set; }
        
        /// <summary>
        /// User ID (GUID) of the user who last modified this booking.
        /// Null if never modified or for legacy bookings.
        /// </summary>
        public string? ModifiedByUserId { get; set; }
        
        /// <summary>
        /// Timestamp of the last modification to this booking.
        /// Null if never modified.
        /// </summary>
        public DateTime? ModifiedOnUtc { get; set; }
        
        /// <summary>
        /// Gets the display status - prefers CurrentRideStatus if set, otherwise falls back to Status
        /// </summary>
        public string DisplayStatus => CurrentRideStatus ?? Status ?? "Unknown";
    }
    
    /// <summary>
    /// Handle real-time status updates from SignalR
    /// </summary>
    private async void OnRideStatusChanged(object? sender, RideStatusChangedEvent evt)
    {
        await InvokeAsync(async () =>
        {
            // Check if this event is for the booking we're viewing
            if (booking != null && booking.Id == evt.RideId)
            {
                // Update the status
                booking.CurrentRideStatus = evt.NewStatus;
                
                Console.WriteLine($"[BookingDetail] Ride {evt.RideId} status updated to {evt.NewStatus} by {evt.DriverName}");
                
                // If the ride just became trackable, load location data
                if (IsTrackable(booking) && driverLocation == null)
                {
                    await LoadDriverLocationAsync();
                }
                
                StateHasChanged();
            }
        });
    }
    
    /// <summary>
    /// Clean up SignalR subscriptions
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        TrackingService.RideStatusChanged -= OnRideStatusChanged;
        await ValueTask.CompletedTask;
    }
}
