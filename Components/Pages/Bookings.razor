@page "/bookings"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using BellwoodGlobal.Core.Domain
@using Bellwood.AdminPortal.Services
@using Bellwood.AdminPortal.Auth
@attribute [StaffAuthorize]
@inject IHttpClientFactory HttpFactory
@inject IAuthTokenProvider TokenProvider

<PageTitle>Bookings Dashboard - Bellwood Elite</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="text-bellwood-gold">📋 Bookings Dashboard</h2>
        </div>
    </div>

    <!-- Filter Buttons -->
    <div class="row mb-3">
        <div class="col">
            <div class="btn-group" role="group">
                <button class="btn @(selectedFilter == "All" ? "btn-primary" : "btn-outline-secondary")"
                        @onclick='() => FilterBookings("All")'>
                    All (@allBookings.Count)
                </button>
                <button class="btn @(selectedFilter == "Requested" ? "btn-warning" : "btn-outline-secondary")"
                        @onclick='() => FilterBookings("Requested")'>
                    Requested (@GetCountByStatus("Requested"))
                </button>
                <button class="btn @(selectedFilter == "Confirmed" ? "btn-success" : "btn-outline-secondary")"
                        @onclick='() => FilterBookings("Confirmed")'>
                    Confirmed (@GetCountByStatus("Confirmed"))
                </button>
                <button class="btn @(selectedFilter == "Completed" ? "btn-secondary" : "btn-outline-secondary")"
                        @onclick='() => FilterBookings("Completed")'>
                    Completed (@GetCountByStatus("Completed"))
                </button>
                <button class="btn @(selectedFilter == "Cancelled" ? "btn-danger" : "btn-outline-secondary")"
                        @onclick='() => FilterBookings("Cancelled")'>
                    Cancelled (@GetCountByStatus("Cancelled"))
                </button>
            </div>
            <button class="btn btn-primary ms-3" @onclick="LoadBookingsAsync">
                🔄 Refresh
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Search by name, location..."
                   @bind="searchQuery" @bind:event="oninput" />
        </div>
    </div>

    <!-- Bookings List -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-bellwood-gold" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!filteredBookings.Any())
    {
        <div class="alert alert-info">
            No bookings found. Try changing your filter or search query.
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var booking in filteredBookings)
            {
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card" style="cursor: pointer;" @onclick="() => ViewDetails(booking.Id)">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">@booking.PassengerName</h5>
                                <span class="status-chip status-@(booking.Status?.ToLower() ?? "requested")">
                                    @booking.Status
                                </span>
                            </div>
                            <p class="card-text text-muted mb-1">
                                <strong>@booking.VehicleClass</strong> • @booking.PickupDateTime.ToLocalTime().ToString("g")
                            </p>
                            <p class="card-text mb-1">
                                📍 @booking.PickupLocation
                            </p>
                            <p class="card-text text-muted small">
                                Booker: @booking.BookerName • Created: @booking.CreatedUtc.ToLocalTime().ToString("g")
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<BookingListItem> allBookings = new();
    private List<BookingListItem> filteredBookings = new();
    private string selectedFilter = "All";
    private string searchQuery = "";
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("Bookings: OnInitializedAsync running");
        await LoadBookingsAsync();
    }

    private async Task LoadBookingsAsync()
    {
        isLoading = true;
        Console.WriteLine("Bookings: starting LoadBookingsAsync");
        try
        {
            var client = HttpFactory.CreateClient("AdminAPI");
            Console.WriteLine("Bookings: calling AdminAPI /bookings/list?take=100");
            var token = await TokenProvider.GetTokenAsync();
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            allBookings = await client.GetFromJsonAsync<List<BookingListItem>>("/bookings/list?take=100") ?? new();
            Console.WriteLine($"Bookings: received {allBookings.Count} bookings");
            FilterBookings(selectedFilter);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading bookings: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterBookings(string status)
    {
        selectedFilter = status;
        filteredBookings = status == "All"
            ? allBookings.Where(MatchesSearch).ToList()
            : allBookings.Where(b => b.Status?.Equals(status, StringComparison.OrdinalIgnoreCase) == true)
                         .Where(MatchesSearch).ToList();
    }

    private bool MatchesSearch(BookingListItem b)
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) return true;
        var query = searchQuery.ToLowerInvariant();
        return b.PassengerName?.Contains(query, StringComparison.OrdinalIgnoreCase) == true ||
               b.BookerName?.Contains(query, StringComparison.OrdinalIgnoreCase) == true ||
               b.PickupLocation?.Contains(query, StringComparison.OrdinalIgnoreCase) == true ||
               b.DropoffLocation?.Contains(query, StringComparison.OrdinalIgnoreCase) == true;
    }

    private int GetCountByStatus(string status)
    {
        return allBookings.Count(b => b.Status?.Equals(status, StringComparison.OrdinalIgnoreCase) == true);
    }

    private void ViewDetails(string bookingId)
    {
        // TODO: Navigate to detail page
        Console.WriteLine($"View booking: {bookingId}");
    }

    // DTO model (matches mobile app)
    public class BookingListItem
    {
        public string Id { get; set; } = "";
        public DateTime CreatedUtc { get; set; }
        public string? Status { get; set; }
        public string BookerName { get; set; } = "";
        public string PassengerName { get; set; } = "";
        public string VehicleClass { get; set; } = "";
        public string PickupLocation { get; set; } = "";
        public string? DropoffLocation { get; set; }
        public DateTime PickupDateTime { get; set; }
    }
}