# System Architecture

**Document Type**: Living Document - Technical Reference  
**Last Updated**: January 17, 2026  
**Status**: ? Production Ready

---

## ?? Overview

The Bellwood AdminPortal is a **Blazor Server** web application that provides administrative staff with real-time management capabilities for the Bellwood Global executive car service platform. It integrates with two backend services (AuthServer and AdminAPI) to deliver a comprehensive dispatch and operations management experience.

**Target Audience**: Developers, architects, DevOps engineers  
**Prerequisites**: Understanding of Blazor Server, SignalR, JWT authentication, ASP.NET Core

---

## ?? Bellwood Ecosystem

The AdminPortal is one component in a five-service architecture:

```
???????????????????????????????????????????????????????????????????
?                    BELLWOOD ECOSYSTEM                            ?
???????????????????????????????????????????????????????????????????

     ????????????????      ????????????????      ????????????????
     ?  AuthServer  ?      ?   AdminAPI   ?      ? AdminPortal  ?
     ?              ?      ?              ?      ?              ?
     ?   :5001      ?      ?   :5206      ?      ?   :7257      ?
     ?              ?      ?              ?      ?              ?
     ? - User DB    ?      ? - Bookings   ?      ? - Blazor UI  ?
     ? - JWT Tokens ?      ? - Quotes     ?      ? - Staff      ?
     ? - Identity   ?      ? - SignalR    ?      ? - Dashboard  ?
     ????????????????      ????????????????      ????????????????
            ?                     ?                      ?
            ????????? Authentication ????????????????????
            ????????? API Calls (JWT + API Key) ?????????

     ????????????????                      ????????????????
     ? PassengerApp ?                      ?  DriverApp   ?
     ?   (MAUI)     ?                      ?   (MAUI)     ?
     ????????????????                      ????????????????
```

### Integration Points

| Service | Technology | Purpose | Authentication |
|---------|-----------|---------|----------------|
| **AuthServer** | ASP.NET Core Identity | Issues JWT tokens with role/uid claims | N/A |
| **AdminAPI** | Minimal APIs + SignalR | Backend services, GPS tracking, data storage | JWT (admin/dispatcher role) |
| **AdminPortal** | Blazor Server | This application - Dispatch operations | JWT (admin role) |
| **PassengerApp** | .NET MAUI | Customer booking and ride tracking | JWT (email claim) |
| **DriverApp** | .NET MAUI | Driver assignments and GPS updates | JWT (driver role + uid) |

---

## ??? AdminPortal Components

### High-Level Architecture

```
AdminPortal (Blazor Server)
?
??? Components/
?   ??? App.razor ?????????????????? Root component
?   ?   ??? <CascadingAuthenticationState>
?   ?       ??? <Router>
?   ?           ??? <Found> ? AuthorizeRouteView
?   ?           ??? <NotFound> ? 404 page
?   ?
?   ??? Layout/
?   ?   ??? MainLayout.razor ????? Authenticated pages
?   ?   ?   ??? <NavMenu />
?   ?   ?   ??? @Body (page content)
?   ?   ?
?   ?   ??? EmptyLayout.razor ???? Login/public pages
?   ?       ??? @Body (minimal)
?   ?
?   ??? Pages/
?       ??? Home.razor (@page "/")
?       ??? Login.razor (@page "/login")
?       ??? Bookings.razor (@page "/bookings")
?       ??? BookingDetail.razor (@page "/bookings/{id}")
?       ??? LiveTracking.razor (@page "/tracking")
?       ??? Quotes.razor (@page "/quotes")
?       ??? QuoteDetail.razor (@page "/quotes/{id}")
?       ??? Affiliates.razor (@page "/affiliates")
?       ??? Logout.razor (@page "/logout")
?
??? Services/
?   ??? JwtAuthenticationStateProvider.cs ? Auth state bridge
?   ??? AuthTokenProvider.cs ????????????? Token storage
?   ??? DriverTrackingService.cs ?????????? SignalR client
?   ??? AffiliateService.cs ??????????????? Affiliate/driver management
?   ??? QuoteService.cs ??????????????????? Quote management
?
??? Models/
?   ??? DriverTrackingModels.cs ??????????? Location DTOs
?   ??? AffiliateModels.cs ???????????????? Affiliate/Driver DTOs
?   ??? QuoteModels.cs ???????????????????? Quote DTOs
?
??? Program.cs ?????????????????????????? DI & middleware setup
```

---

## ?? Authentication Flow

### Complete Login Sequence

```
????????????
? Browser  ?
????????????
     ?
     ? 1. GET https://localhost:7257/
     ?
     ?
???????????????????????????????????????????????????????????????
? AdminPortal (Blazor Server)                                  ?
?                                                              ?
?  ??????????????????????????????????????????????????????    ?
?  ? App.razor                                          ?    ?
?  ?   <CascadingAuthenticationState>                   ?    ?
?  ?     <Router>                                       ?    ?
?  ?       <AuthorizeRouteView>                         ?    ?
?  ?         Checks: AuthenticationStateProvider        ?    ?
?  ??????????????????????????????????????????????????????    ?
?                       ?                                     ?
?                       ? Not Authenticated                   ?
?                       ?                                     ?
?  ??????????????????????????????????????????????????????    ?
?  ? Home.razor (/)                                     ?    ?
?  ?   <AuthorizeView>                                  ?    ?
?  ?     <NotAuthorized>                                ?    ?
?  ?       Navigation.NavigateTo("/login")              ?    ?
?  ??????????????????????????????????????????????????????    ?
?                       ?                                     ?
???????????????????????????????????????????????????????????????
                        ?
                        ? 2. Redirect to /login
                        ?
???????????????????????????????????????????????????????????????
? Login.razor                                                  ?
?   @rendermode InteractiveServer                              ?
?   @layout EmptyLayout                                        ?
?                                                              ?
?   <EditForm>                                                 ?
?     Username: [alice    ]                                    ?
?     Password: [••••••••]                                     ?
?     [Login Button]                                           ?
?   </EditForm>                                                ?
???????????????????????????????????????????????????????????????
                        ?
                        ? 3. POST /api/auth/login
                        ?    { username, password }
                        ?
???????????????????????????????????????????????????????????????
? AuthServer (ASP.NET Core Identity)                           ?
?                                                              ?
?  /api/auth/login endpoint:                                   ?
?    1. Validate credentials against user database             ?
?    2. If valid, generate JWT token                           ?
?    3. Return: { accessToken, refreshToken }                  ?
???????????????????????????????????????????????????????????????
                        ?
                        ? 4. Response: { accessToken: "eyJ..." }
                        ?
???????????????????????????????????????????????????????????????
? AdminPortal - Login.razor                                    ?
?                                                              ?
?  await AuthStateProvider                                     ?
?    .MarkUserAsAuthenticatedAsync(username, token);           ?
?                                                              ?
?  This does:                                                  ?
?    1. Store token ? AuthTokenProvider                        ?
?    2. Create Claims (Name, Role, Token)                      ?
?    3. Notify Blazor: NotifyAuthenticationStateChanged()      ?
?                                                              ?
?  Navigation.NavigateTo("/main", forceLoad: false);           ?
???????????????????????????????????????????????????????????????
                        ?
                        ? 5. Navigate to /main
                        ?
???????????????????????????????????????????????????????????????
? Bookings.razor                                               ?
?                                                              ?
?  <AuthorizeView>                                             ?
?    <Authorized> ? (State was updated in step 4!)           ?
?                                                              ?
?      protected override async Task OnInitializedAsync() {    ?
?        await LoadBookingsAsync();                            ?
?      }                                                       ?
???????????????????????????????????????????????????????????????
                        ?
                        ? 6. GET /bookings/list?take=100
                        ?    Headers:
                        ?      X-Admin-ApiKey: dev-secret-123
                        ?      Authorization: Bearer eyJ...
                        ?
???????????????????????????????????????????????????????????????
? AdminAPI                                                     ?
?                                                              ?
?  app.MapGet("/bookings/list", async (req, repo) => {         ?
?    // Validate API key + JWT                                 ?
?    // Fetch bookings                                         ?
?    return Results.Ok(bookings);                              ?
?  });                                                         ?
???????????????????????????????????????????????????????????????
                        ?
                        ? 7. Response: [{ booking1 }, ...]
                        ?
???????????????????????????????????????????????????????????????
? Bookings.razor                                               ?
?                                                              ?
?  allBookings = await response.Content                        ?
?    .ReadFromJsonAsync<List<BookingListItem>>();              ?
?                                                              ?
?  FilterBookings("All");                                      ?
?                                                              ?
?  ?? Bookings Dashboard displays with data                    ?
???????????????????????????????????????????????????????????????
```

---

## ?? Authentication State Management

### State Flow Diagram

```
Login Success
    ?
    ??? AuthTokenProvider.SetTokenAsync(token)
    ?   ??? Stores token in singleton instance (_cachedToken)
    ?
    ??? JwtAuthenticationStateProvider
            .MarkUserAsAuthenticatedAsync(username, token)
        ?
        ??? Creates ClaimsPrincipal with:
        ?   - ClaimTypes.Name = username
        ?   - ClaimTypes.Role = "Staff"
        ?   - "access_token" = token
        ?
        ??? NotifyAuthenticationStateChanged()
            ?
            ??? Triggers re-evaluation in:
                ??? <AuthorizeView> components
                ??? <AuthorizeRouteView> routing
                ??? @context in authorized sections

On Logout
    ?
    ??? AuthTokenProvider.ClearTokenAsync()
    ?   ??? Sets _cachedToken = null
    ?
    ??? JwtAuthenticationStateProvider
            .MarkUserAsLoggedOutAsync()
        ?
        ??? Creates empty ClaimsPrincipal
            ??? NotifyAuthenticationStateChanged()
                ??? User sees <NotAuthorized> content
```

### Service Lifetime (Critical Design Decision)

**Decision**: Use **Singleton** for authentication services

```csharp
// Program.cs
builder.Services.AddSingleton<IAuthTokenProvider, AuthTokenProvider>();
builder.Services.AddSingleton<JwtAuthenticationStateProvider>();
builder.Services.AddSingleton<AuthenticationStateProvider>(sp =>
    sp.GetRequiredService<JwtAuthenticationStateProvider>()
);
```

**Rationale**:
- Blazor Server creates new circuits during navigation
- **Scoped** services = new instance per circuit = lost auth state
- **Singleton** = same instance across all circuits = persistent auth state

**Impact**: Solved "blank page after login" bug (see [32-Troubleshooting.md](32-Troubleshooting.md#service-lifetime-issue))

---

## ?? Real-Time Communication (SignalR)

### SignalR Architecture

```
???????????????????????????????????????????????????????????????
? AdminPortal (SignalR Client)                                 ?
?                                                              ?
?  DriverTrackingService.cs                                    ?
?    ??? HubConnection                                         ?
?    ??? Connection URL: /hubs/location?access_token={jwt}    ?
?    ??? Auto-reconnect: 0s, 2s, 5s, 10s exponential backoff  ?
???????????????????????????????????????????????????????????????
                        ?
                        ? WebSocket (SignalR)
                        ?
???????????????????????????????????????????????????????????????
? AdminAPI (SignalR Hub)                                       ?
?                                                              ?
?  LocationHub                                                 ?
?    ??? OnConnectedAsync() - Auto-join "admin" group         ?
?    ??? SubscribeToRide(rideId)                              ?
?    ??? SubscribeToDriver(driverUid)                         ?
?    ??? Broadcast events:                                    ?
?        ??? LocationUpdate                                    ?
?        ??? RideStatusChanged                                 ?
?        ??? TrackingStopped                                   ?
???????????????????????????????????????????????????????????????
                        ?
                        ? GPS Updates from DriverApp
                        ?
???????????????????????????????????????????????????????????????
? DriverApp (MAUI)                                             ?
?                                                              ?
?  POST /driver/location/update                                ?
?    { rideId, lat, lng, speed, heading, accuracy }            ?
???????????????????????????????????????????????????????????????
```

### Event Flow

1. **Driver sends GPS update** ? `POST /driver/location/update`
2. **AdminAPI persists location** ? File storage
3. **AdminAPI broadcasts event** ? `LocationUpdate` to "admin" group
4. **AdminPortal receives event** ? Updates UI via `StateHasChanged()`
5. **Map updates in real-time** ? No manual refresh needed

**See**: [10-Real-Time-Tracking.md](10-Real-Time-Tracking.md) and [21-SignalR-Reference.md](21-SignalR-Reference.md) for complete details

---

## ?? HTTP Client Configuration

### Named HttpClient Pattern

```csharp
// Program.cs
builder.Services.AddHttpClient("AuthServer", client =>
{
    client.BaseAddress = new Uri("https://localhost:5001");
    client.Timeout = TimeSpan.FromSeconds(30);
});

builder.Services.AddHttpClient("AdminAPI", client =>
{
    client.BaseAddress = new Uri("https://localhost:5206");
    client.Timeout = TimeSpan.FromSeconds(30);
});
```

### Usage in Services

```csharp
// QuoteService.cs
public class QuoteService : IQuoteService
{
    private readonly IHttpClientFactory _httpFactory;
    private readonly IAuthTokenProvider _tokenProvider;
    private readonly IAdminApiKeyProvider _apiKeyProvider;

    private async Task<HttpClient> GetAuthorizedClientAsync()
    {
        var client = _httpFactory.CreateClient("AdminAPI");
        
        // Add API key
        var apiKey = _apiKeyProvider.GetApiKey();
        client.DefaultRequestHeaders.TryAddWithoutValidation(
            "X-Admin-ApiKey", apiKey);
        
        // Add JWT token
        var token = await _tokenProvider.GetTokenAsync();
        client.DefaultRequestHeaders.Authorization = 
            new AuthenticationHeaderValue("Bearer", token);
        
        return client;
    }
}
```

---

## ??? Technology Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| **.NET** | 8.0 | Runtime framework |
| **Blazor Server** | 8.0 | Web UI framework with server-side rendering |
| **SignalR** | 8.0 | Real-time bi-directional communication |
| **ASP.NET Core Identity** | 8.0 | Authentication (via AuthServer) |
| **Bootstrap** | 5.3 | CSS framework for responsive UI |
| **Google Maps JavaScript API** | - | Interactive mapping and GPS visualization |
| **JavaScript Interop** | - | Blazor-to-JS communication for map control |

---

## ?? Design Decisions

### Decision 1: Blazor Server vs Blazor WebAssembly

**Problem**: Choose between Blazor Server (server-side rendering) and Blazor WebAssembly (client-side)

**Options Considered**:
- **Blazor Server**: Rendering on server, SignalR for UI updates
- **Blazor WebAssembly**: Client-side SPA, API calls from browser

**Decision**: **Blazor Server**

**Rationale**:
- ? Real-time SignalR already required for GPS tracking
- ? Faster initial load (no WASM download)
- ? Full .NET capabilities on server
- ? Secure token storage (not in browser)
- ? Better for admin tools (internal users, controlled network)
- ? WebAssembly pros: offline support, CDN hosting (not needed for admin portal)

---

### Decision 2: Singleton vs Scoped for Auth Services

**Problem**: Authentication state lost during navigation

**Options Considered**:
- **Scoped**: New instance per circuit (standard Blazor pattern)
- **Singleton**: Same instance across all circuits
- **Session Storage**: Browser storage for token persistence

**Decision**: **Singleton** for auth services

**Rationale**:
- ? Solves circuit recreation issue during navigation
- ? Simple implementation (no browser storage complexity)
- ? Works immediately without additional dependencies
- ? Easy to migrate when adding OAuth 2.0
- ? Scoped would work with session storage but adds complexity

**Impact**: Fixed "blank page after login" critical bug

---

### Decision 3: Dual Status Model (Status + CurrentRideStatus)

**Problem**: Need both booking-level status (for reports) and real-time driver status (for operations)

**Options Considered**:
- **Single status field**: Overwrite status when driver updates
- **Dual status**: Separate fields for booking vs driver state
- **Status history**: Track all status changes in timeline

**Decision**: **Dual status model**

**Rationale**:
- ? `Status` (Requested, Confirmed, InProgress, Completed) for business reporting
- ? `CurrentRideStatus` (OnRoute, Arrived, PassengerOnboard) for real-time operations
- ? UI prefers `CurrentRideStatus` when available, falls back to `Status`
- ? AdminAPI persists both independently
- ? No data loss during status transitions

**See**: [10-Real-Time-Tracking.md](10-Real-Time-Tracking.md#dual-status-model)

---

### Decision 4: File-Based Storage vs Database (AdminAPI)

**Problem**: Where should AdminAPI store booking/quote data?

**Decision**: **File-based JSON storage** (interim solution)

**Rationale**:
- ? Fast implementation for alpha testing
- ? No database infrastructure required initially
- ? Easy to migrate data to SQL later
- ? Human-readable files for debugging
- ? Not production-ready (no ACID, scaling limits)

**Future**: Migrate to Azure SQL or Cosmos DB for production

---

## ?? Data Flow Patterns

### Booking List Loading

```
Bookings.razor (OnInitializedAsync)
    ?
    ??? DriverTrackingService.ConnectAsync()
    ?   ??? Establish SignalR connection for real-time updates
    ?
    ??? LoadBookingsAsync()
        ?
        ??? Create HttpClient("AdminAPI")
        ?
        ??? Add headers:
        ?   ??? X-Admin-ApiKey: dev-secret-123
        ?   ??? Authorization: Bearer {jwt}
        ?
        ??? GET /bookings/list?take=100
        ?
        ??? Deserialize: List<BookingListItem>
        ?
        ??? FilterBookings("All")
            ??? Display in UI
